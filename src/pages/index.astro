---
import { getCollection } from "astro:content";
import Layout from "@/layouts/Layout.astro";
import Header from "@/components/Header.astro";
import Footer from "@/components/Footer.astro";
import LinkButton from "@/components/LinkButton.astro";
import Card from "@/components/Card.astro";
import getSortedPosts from "@/utils/getSortedPosts";
import { slugifyStr } from "@/utils/slugify";
import IconArrowRight from "@/assets/icons/IconArrowRight.svg";
import { SITE } from "@/config";

const posts = await getCollection("blog");
const sortedPosts = getSortedPosts(posts);
const featuredPosts = sortedPosts.filter(({ data }) => data.featured);
const recentPosts = sortedPosts.filter(({ data }) => !data.featured);
const latestPost = sortedPosts[0];

const allTags = sortedPosts.flatMap(({ data }) => data.tags ?? []);
const tagFrequency = allTags.reduce<Record<string, number>>((acc, rawTag) => {
  const tag = rawTag?.trim();
  if (!tag) return acc;
  acc[tag] = (acc[tag] ?? 0) + 1;
  return acc;
}, {});

const trendingTags = Object.entries(tagFrequency)
  .sort((a, b) => b[1] - a[1])
  .slice(0, 10)
  .map(([name, count]) => ({
    name,
    count,
    slug: slugifyStr(name),
  }));

const totalPosts = sortedPosts.length;
const totalTags = Object.keys(tagFrequency).length;
const totalFeatured = featuredPosts.length;

const topCategories = Object.entries(tagFrequency)
  .sort((a, b) => b[1] - a[1])
  .slice(0, 6)
  .map(([name, count]) => ({
    name,
    count,
    slug: slugifyStr(name),
  }));
---

<Layout>
  <Header />
  <main
    id="main-content"
    data-layout="index"
    class="mx-auto w-full max-w-5xl px-4 pt-4 pb-10 sm:px-6 sm:pt-6"
  >
    <section class="hero-shell mb-8 rounded-3xl p-7 sm:p-10 lg:p-12">
      <div class="max-w-4xl">
        <span class="hero-badge mb-5 inline-flex items-center rounded-full px-3 py-1 text-xs font-semibold tracking-wide uppercase">
          AI Engineering Journal
        </span>
        <h1 class="font-display mb-4 text-4xl font-bold tracking-tight sm:text-5xl lg:text-6xl">
          <span class="gradient-text">{SITE.title}</span>
        </h1>
        <p class="mb-6 max-w-2xl text-base text-foreground/80 sm:text-lg">
          Practical notes on AI assistants, software architecture, and developer tooling.
        </p>

        <div class="flex flex-wrap gap-3">
          <LinkButton href="/posts/" class="cta cta-primary px-5 py-2.5 text-sm font-semibold">
            Read Posts
          </LinkButton>
          <LinkButton href="/about/" class="cta cta-secondary px-5 py-2.5 text-sm font-semibold">
            About This Site
          </LinkButton>
        </div>
      </div>
    </section>

    <section class="mb-8 grid grid-cols-1 gap-3 sm:grid-cols-3">
      <article class="surface-panel p-4">
        <p class="text-xs font-semibold tracking-wide text-foreground/60 uppercase">Posts</p>
        <p class="font-display mt-1 text-3xl font-semibold text-accent">{totalPosts}</p>
      </article>
      <article class="surface-panel p-4">
        <p class="text-xs font-semibold tracking-wide text-foreground/60 uppercase">Tags</p>
        <p class="font-display mt-1 text-3xl font-semibold text-accent">{totalTags}</p>
      </article>
      <article class="surface-panel p-4">
        <p class="text-xs font-semibold tracking-wide text-foreground/60 uppercase">
          Featured
        </p>
        <p class="font-display mt-1 text-3xl font-semibold text-accent">{totalFeatured}</p>
      </article>
    </section>

    {
      latestPost && (
        <section class="surface-panel mb-10 overflow-hidden p-6 sm:p-8">
          <div class="mb-4 flex items-center justify-between gap-2">
            <span class="hero-badge inline-flex items-center rounded-full px-2.5 py-1 text-[11px] font-semibold tracking-wide uppercase">
              Latest
            </span>
            <time class="text-xs text-foreground/55">
              {new Date(
                latestPost.data.modDatetime ?? latestPost.data.pubDatetime
              ).toLocaleDateString("en-US", {
                year: "numeric",
                month: "short",
                day: "numeric",
              })}
            </time>
          </div>

          <a
            href={`/posts/${latestPost.id}/`}
            class="focus-outline block rounded-lg transition-transform duration-200 hover:translate-x-0.5"
          >
            <h2 class="font-display mb-3 text-2xl font-semibold tracking-tight sm:text-3xl">
              {latestPost.data.title}
            </h2>
            <p class="line-clamp-2 max-w-3xl text-foreground/75">{latestPost.data.description}</p>
            <span class="mt-4 inline-flex items-center gap-2 text-sm font-semibold text-accent">
              Continue reading
              <IconArrowRight class="h-4 w-4" />
            </span>
          </a>
        </section>
      )
    }

    <section class="mb-8">
      <div class="mb-4 flex items-end justify-between">
        <h2 class="font-display text-2xl font-semibold tracking-tight">Top Categories</h2>
        <a href="/tags/" class="text-sm font-medium text-foreground/65 hover:text-accent">
          View all tags
        </a>
      </div>
      <div class="grid grid-cols-2 gap-3 sm:grid-cols-3 lg:grid-cols-6">
        {topCategories.map(({ name, slug, count }) => (
          <a
            href={`/tags/${slug}/`}
            class="focus-outline surface-panel block rounded-xl p-3 text-center transition-transform duration-200 hover:-translate-y-0.5"
          >
            <p class="font-display text-2xl font-semibold text-accent">{count}</p>
            <p class="line-clamp-2 mt-1 text-xs font-medium text-foreground/75">{name}</p>
          </a>
        ))}
      </div>
    </section>

    {
      trendingTags.length > 0 && (
        <section class="mb-10">
          <h2 class="font-display mb-3 text-2xl font-semibold tracking-tight">Trending Tags</h2>
          <div class="flex flex-wrap gap-2">
            {trendingTags.map(({ name, slug, count }) => (
              <a
                href={`/tags/${slug}/`}
                class="tag focus-outline rounded-full px-3 py-1.5 text-sm no-underline"
              >
                <span>{name}</span>
                <span class="text-xs text-foreground/55">{count}</span>
              </a>
            ))}
          </div>
        </section>
      )
    }

    {
      featuredPosts.length > 0 && (
        <section class="mb-10">
          <h2 class="font-display mb-4 text-2xl font-semibold tracking-tight">Featured Posts</h2>
          <ul class="grid gap-4 sm:grid-cols-2 lg:grid-cols-3">
            {featuredPosts.map(({ data, id }) => (
              <Card href={`/posts/${id}/`} frontmatter={data} secHeading={false} />
            ))}
          </ul>
        </section>
      )
    }

    {
      recentPosts.length > 0 && (
        <section class="mb-8">
          <div class="mb-4 flex items-end justify-between">
            <h2 class="font-display text-2xl font-semibold tracking-tight">Recent Posts</h2>
            <LinkButton
              href="/posts/"
              class="focus-outline inline-flex items-center gap-1 rounded-lg px-3 py-1.5 text-sm font-medium text-foreground/70 hover:text-accent"
            >
              Browse archive
              <IconArrowRight class="h-4 w-4" />
            </LinkButton>
          </div>

          <ul class="grid gap-4 sm:grid-cols-2 lg:grid-cols-3">
            {recentPosts
              .slice(0, SITE.postPerIndex)
              .map(({ data, id }) => (
                <Card href={`/posts/${id}/`} frontmatter={data} secHeading={false} />
              ))}
          </ul>
        </section>
      )
    }
  </main>
  <Footer />
</Layout>

<script>
  document.addEventListener("astro:page-load", () => {
    const indexLayout = (document.querySelector("#main-content") as HTMLElement)
      ?.dataset?.layout;
    if (indexLayout) {
      sessionStorage.setItem("backUrl", "/");
    }
  });
</script>

<style>
  .hero-shell {
    border: 1px solid color-mix(in srgb, var(--color-border) 82%, transparent);
    background:
      linear-gradient(
        135deg,
        color-mix(in srgb, var(--color-surface) 92%, transparent),
        color-mix(in srgb, var(--color-surface-2) 74%, transparent)
      ),
      radial-gradient(
        circle at 85% 12%,
        color-mix(in srgb, var(--color-accent) 18%, transparent),
        transparent 42%
      );
    box-shadow: var(--shadow);
  }

  .hero-badge {
    border: 1px solid color-mix(in srgb, var(--color-accent) 35%, transparent);
    color: color-mix(in srgb, var(--color-accent) 85%, var(--color-foreground));
    background: color-mix(in srgb, var(--color-accent) 12%, transparent);
  }

  .cta {
    border-radius: 999px;
    transition:
      transform 0.2s ease,
      box-shadow 0.2s ease,
      border-color 0.2s ease;
  }

  .cta:hover {
    transform: translateY(-1px);
  }

  .cta-primary {
    color: #f7fffc;
    background: linear-gradient(
      120deg,
      color-mix(in srgb, var(--color-accent) 92%, black),
      color-mix(in srgb, var(--color-primary) 66%, var(--color-accent))
    );
    box-shadow: var(--shadow-sm);
  }

  .cta-secondary {
    border: 1px solid color-mix(in srgb, var(--color-border) 85%, transparent);
    background: color-mix(in srgb, var(--color-surface) 88%, transparent);
  }
</style>
