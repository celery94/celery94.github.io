---
pubDatetime: 2025-06-18
tags: [EF Core, å¹¶å‘æ§åˆ¶, ä¹è§‚é”, .NET, è½¯ä»¶æ¶æ„]
slug: ef-core-optimistic-locking-race-condition
source: https://www.milanjovanovic.tech/blog/solving-race-conditions-with-ef-core-optimistic-locking
title: ä½¿ç”¨ EF Core ä¹è§‚é”å®šæœºåˆ¶è§£å†³å¹¶å‘å†²çªä¸ç«æ€æ¡ä»¶
description: æœ¬æ–‡é¢å‘ä¸­é«˜çº§ .NET å¼€å‘è€…ï¼Œç³»ç»Ÿè®²è§£äº†åœ¨å®é™…å¼€å‘ä¸­å¦‚ä½•è¯†åˆ«å¹¶è§£å†³å¹¶å‘å†²çªï¼Œè¯¦ç»†è§£æ EF Core ä¹è§‚å¹¶å‘æ§åˆ¶çš„åŸç†ã€åº”ç”¨åŠä»£ç å®ç°ï¼Œå¹¶ç»“åˆå…¸å‹åœºæ™¯åˆ†æå…¶ä¼˜åŠ¿ä¸æŒ‘æˆ˜ï¼Œå¸®åŠ©å¼€å‘è€…æ„å»ºå¥å£®å¯é çš„ä¸šåŠ¡ç³»ç»Ÿã€‚
ogImage: "@/assets/cover/370.png"
---

# ä½¿ç”¨ EF Core ä¹è§‚é”å®šæœºåˆ¶è§£å†³å¹¶å‘å†²çªä¸ç«æ€æ¡ä»¶

## å¼•è¨€

åœ¨ä¼ä¸šçº§åº”ç”¨å¼€å‘ä¸­ï¼Œæ•°æ®ä¸€è‡´æ€§ä¸å¹¶å‘å®‰å…¨å§‹ç»ˆæ˜¯è½¯ä»¶æ¶æ„è®¾è®¡çš„æ ¸å¿ƒé—®é¢˜ä¹‹ä¸€ã€‚å°¤å…¶æ˜¯åœ¨å¤šçº¿ç¨‹æˆ–é«˜å¹¶å‘ç¯å¢ƒä¸‹ï¼Œ**ç«æ€æ¡ä»¶ï¼ˆRace Conditionï¼‰**ææ˜“å¯¼è‡´ä¸šåŠ¡é€»è¾‘æ··ä¹±ç”šè‡³æ•°æ®æŸåã€‚ä»¥é¢„è®¢ç³»ç»Ÿä¸ºä¾‹ï¼Œå¦‚æœä¸æ°å½“å¤„ç†å¹¶å‘è®¿é—®ï¼Œå¯èƒ½ä¼šå‡ºç°åŒä¸€æˆ¿æºè¢«å¤šæ¬¡é¢„è®¢çš„ä¸¥é‡é”™è¯¯ã€‚æœ¬æ–‡å°†ç»“åˆçœŸå®ä»£ç ç¤ºä¾‹ï¼Œæ·±å…¥å‰–æå¦‚ä½•åˆ©ç”¨ **Entity Framework Coreï¼ˆEF Coreï¼‰** çš„ä¹è§‚å¹¶å‘æ§åˆ¶æœºåˆ¶ï¼Œæœ‰æ•ˆé˜²æ­¢æ­¤ç±»ç«æ€é—®é¢˜ï¼Œæå‡ç³»ç»Ÿå¥å£®æ€§ã€‚

## å¹¶å‘å†²çªä¸ç«æ€æ¡ä»¶ï¼šèƒŒæ™¯åŠé—®é¢˜åˆ†æ

å¹¶å‘å†²çªæŒ‡å¤šä¸ªçº¿ç¨‹æˆ–è¯·æ±‚åŒæ—¶è®¿é—®å’Œä¿®æ”¹åŒä¸€ä»½æ•°æ®æ—¶ï¼Œç”±äºç¼ºä¹åˆç†çš„åŒæ­¥æœºåˆ¶ï¼Œå¯¼è‡´æ•°æ®çŠ¶æ€å¼‚å¸¸ã€‚åœ¨ç°å®å¼€å‘ä¸­ï¼Œå¼€å‘è€…ç»å¸¸å¿½ç•¥è¿™ç±»éšè”½é£é™©ã€‚ä¾‹å¦‚ï¼Œå‡è®¾æœ‰å¦‚ä¸‹é¢„è®¢å¤„ç†é€»è¾‘ï¼š

```csharp
public Result<Guid> Handle(
    ReserveBooking command,
    AppDbContext dbContext)
{
    var user = dbContext.Users.GetById(command.UserId);
    var apartment = dbContext.Apartments.GetById(command.ApartmentId);
    var (startDate, endDate) = command;

    if (dbContext.Bookings.IsOverlapping(apartment, startDate, endDate))
    {
        return Result.Failure<Guid>(BookingErrors.Overlap);
    }

    var booking = Booking.Reserve(apartment, user, startDate, endDate);

    dbContext.Add(booking);

    dbContext.SaveChanges();

    return booking.Id;
}
```

**é—®é¢˜åˆ†æï¼š**  
ä¸Šé¢ä»£ç è™½ç„¶åšäº†é‡å é¢„è®¢æ£€æŸ¥ï¼Œä½†åœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹ï¼Œä¸¤æ¬¡è¯·æ±‚å¯èƒ½å‡ ä¹åŒæ—¶é€šè¿‡ `IsOverlapping` æ£€æŸ¥ï¼Œç„¶åå„è‡ªæ’å…¥é¢„è®¢ï¼Œé€ æˆä¸šåŠ¡å†²çªã€‚è¿™ç§â€œå…ˆæŸ¥è¯¢åæ›´æ–°â€çš„æ¨¡å¼åœ¨æ²¡æœ‰å¹¶å‘æ§åˆ¶çš„æƒ…å†µä¸‹æ— æ³•ä¿è¯æ•°æ®ä¸€è‡´æ€§ã€‚

## ä¹è§‚å¹¶å‘æ§åˆ¶åŸç†åŠ EF Core å®ç°

é’ˆå¯¹ä¸Šè¿°é—®é¢˜ï¼Œå¸¸è§çš„è§£å†³æ–¹æ¡ˆåŒ…æ‹¬**æ‚²è§‚é”å®š**å’Œ**ä¹è§‚é”å®š**ï¼š

- **æ‚²è§‚é”å®šï¼ˆPessimistic Lockingï¼‰**ï¼šå¯¹å…³é”®èµ„æºåŠ é”ï¼Œé˜»å¡å…¶ä»–å¹¶å‘æ“ä½œã€‚å®ç°ç®€å•ä½†æ€§èƒ½ä½ä¸‹ï¼ŒEF Core åŸç”Ÿä¸æ”¯æŒã€‚
- **ä¹è§‚é”å®šï¼ˆOptimistic Lockingï¼‰**ï¼šå‡å®šå†²çªè¾ƒå°‘ï¼Œä¸ä¸»åŠ¨åŠ é”ã€‚æäº¤æ—¶æ ¡éªŒå…³é”®å­—æ®µï¼ˆå¦‚ç‰ˆæœ¬å·ï¼‰ï¼Œå‘ç°æ•°æ®å·²å˜æ›´åˆ™æ‹’ç»ä¿å­˜ã€‚é€‚åˆé«˜ååã€é«˜å¯æ‰©å±•åœºæ™¯ã€‚

EF Core æ”¯æŒä¹è§‚å¹¶å‘æ§åˆ¶ï¼Œåªéœ€ä¸ºå®ä½“é…ç½®â€œå¹¶å‘æ ‡è®°ï¼ˆConcurrency Tokenï¼‰â€ï¼Œå¦‚ SQL Server çš„ `rowversion` å­—æ®µã€‚

### å®ä½“é…ç½®æ–¹å¼

1. **å±æ€§æ³¨è§£æ–¹å¼**

```csharp
public class Apartment
{
    public Guid Id { get; set; }

    [Timestamp]
    public byte[] Version { get; set; }
}
```

2. **Fluent API æ–¹å¼ï¼ˆæ¨èï¼Œé¿å…æ±¡æŸ“å®ä½“æ¨¡å‹ï¼‰**

```csharp
protected override void OnModelCreating(ModelBuilder modelBuilder)
{
    modelBuilder.Entity<Apartment>()
        .Property<byte[]>("Version")
        .IsRowVersion();
}
```

> âš ï¸ ä¸åŒæ•°æ®åº“å¯¹å¹¶å‘æ§åˆ¶å­—æ®µæ”¯æŒæ–¹å¼ä¸åŒï¼Œè¯·æŸ¥é˜…å¯¹åº”æ–‡æ¡£ã€‚

### å·¥ä½œæœºåˆ¶è¯¦è§£

å½“å¯ç”¨ä¹è§‚é”åï¼š

- æŸ¥è¯¢å®ä½“æ—¶ä¼šä¸€åŒåŠ è½½å¹¶å‘æ ‡è®°ï¼ˆå¦‚ `Version`ï¼‰ã€‚
- æ›´æ–°æˆ–æ’å…¥æ—¶ï¼ŒEF Core ç”Ÿæˆå¸¦æœ‰ç‰ˆæœ¬å·æ ¡éªŒçš„ SQL è¯­å¥ã€‚ä¾‹å¦‚ï¼š

```sql
UPDATE Apartments
SET LastBookedOnUtc = @p0
WHERE Id = @p1 AND Version = @p2;
```

- è‹¥æœŸé—´å…¶ä»–è¯·æ±‚å·²ä¿®æ”¹è¯¥å®ä½“ï¼Œåˆ™ `Version` ä¸åŒ¹é…ï¼Œæ— è¡Œè¢«æ›´æ–°ï¼ŒEF Core æŠ›å‡º `DbUpdateConcurrencyException`ã€‚

### ä»£ç å®ç°ä¸å¼‚å¸¸å¤„ç†

æ”¹è¿›åçš„é¢„è®¢å¤„ç†å¦‚ä¸‹ï¼š

```csharp
public Result<Guid> Handle(
    ReserveBooking command,
    AppDbContext dbContext)
{
    var user = dbContext.Users.GetById(command.UserId);
    var apartment = dbContext.Apartments.GetById(command.ApartmentId);
    var (startDate, endDate) = command;

    if (dbContext.Bookings.IsOverlapping(apartment, startDate, endDate))
    {
        return Result.Failure<Guid>(BookingErrors.Overlap);
    }

    try
    {
        var booking = Booking.Reserve(apartment, user, startDate, endDate);
        dbContext.Add(booking);
        dbContext.SaveChanges();
        return booking.Id;
    }
    catch (DbUpdateConcurrencyException)
    {
        // å¹¶å‘å†²çªæ—¶è¿”å›é‡å é”™è¯¯
        return Result.Failure<Guid>(BookingErrors.Overlap);
    }
}
```

é€šè¿‡æ•è·å¹¶å¤„ç† `DbUpdateConcurrencyException`ï¼Œç¡®ä¿å³ä½¿æç«¯å¹¶å‘åœºæ™¯ä¸‹ï¼Œä¹Ÿä¸ä¼šå‡ºç°é‡å¤é¢„è®¢ç­‰ä¸šåŠ¡å¼‚å¸¸ã€‚

## ä¹è§‚å¹¶å‘æ§åˆ¶çš„é€‚ç”¨åœºæ™¯ä¸æŒ‘æˆ˜

**ä¼˜åŠ¿ï¼š**

- æ€§èƒ½ä¼˜å¼‚ï¼Œæ— éœ€é•¿æ—¶é—´æŒæœ‰æ•°æ®åº“è¿æ¥ã€‚
- é¿å…å¤§èŒƒå›´é˜»å¡ï¼Œé€‚åˆå¤§éƒ¨åˆ†é«˜å¹¶å‘ Web åº”ç”¨ã€‚
- ä¸ DDDã€CQRS ç­‰æ¶æ„ç†å¿µé«˜åº¦å¥‘åˆã€‚

**æŒ‘æˆ˜ï¼š**

- å¹¶å‘å†²çªéœ€ä¸šåŠ¡å±‚æ˜¾å¼å¤„ç†ï¼Œå¦‚é‡è¯•ã€ç”¨æˆ·æç¤ºç­‰ã€‚
- åœ¨æé«˜å†²çªæ¦‚ç‡åœºæ™¯ä¸‹ï¼ˆå¦‚é‡‘èç³»ç»Ÿï¼‰ï¼Œéœ€è°¨æ…è¯„ä¼°ä¹è§‚é”é€‚ç”¨æ€§ã€‚
- æŸäº›æ‰¹é‡æ“ä½œ/èšåˆæ“ä½œæ—¶å¤„ç†å¤æ‚åº¦æå‡ã€‚

## ç»“è®ºä¸å»ºè®®

ä¹è§‚å¹¶å‘æ§åˆ¶æ˜¯ç°ä»£ä¼ä¸šçº§ç³»ç»Ÿç¡®ä¿æ•°æ®ä¸€è‡´æ€§çš„åˆ©å™¨ã€‚å¯¹äºå¤§å¤šæ•°ä»¥è¯»ä¸ºä¸»ã€å†™å†²çªæ¦‚ç‡ä½çš„ä¸šåŠ¡ç³»ç»Ÿï¼ˆå¦‚ç”µå•†ã€SaaS ç®¡ç†åå°ç­‰ï¼‰ï¼Œå»ºè®®ä¼˜å…ˆé‡‡ç”¨ EF Core çš„ä¹è§‚é”æœºåˆ¶ï¼Œé€šè¿‡é…ç½®å®ä½“ç‰ˆæœ¬å·å’Œåˆç†çš„å¼‚å¸¸å¤„ç†ï¼Œå¤§å¹…é™ä½ç«æ€é£é™©ã€‚å¯¹äºç‰¹æ®Šé«˜é£é™©é¢†åŸŸï¼Œå¯è€ƒè™‘é…åˆæ¶ˆæ¯é˜Ÿåˆ—ã€äº‹ä»¶æº¯æºç­‰é«˜çº§æŠ€æœ¯è¿›ä¸€æ­¥å¢å¼ºä¸€è‡´æ€§ä¿éšœã€‚

> ğŸ›¡ï¸ **æœ€ä½³å®è·µå»ºè®®ï¼š**
>
> - æ‰€æœ‰æ¶‰åŠå…³é”®ä¸šåŠ¡çº¦æŸï¼ˆå¦‚ä¸å¯é‡å¤é¢„è®¢ã€å”¯ä¸€åº“å­˜åˆ†é…ç­‰ï¼‰çš„é¢†åŸŸé€»è¾‘ï¼ŒåŠ¡å¿…ä½¿ç”¨å¹¶å‘æ§åˆ¶æœºåˆ¶ã€‚
> - é’ˆå¯¹é«˜é¢‘å†²çªåœºæ™¯åŠæ—¶ç›‘æ§ã€ä¼˜åŒ–ä¸šåŠ¡æµç¨‹æˆ–é‡‡ç”¨ä¸“ç”¨åˆ†å¸ƒå¼é”æ–¹æ¡ˆã€‚
> - åŠ å¼ºå•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•è¦†ç›–å¤šçº¿ç¨‹åŠé«˜å¹¶å‘è¾¹ç•Œæƒ…å½¢ã€‚

é€šè¿‡åˆç†è¿ç”¨ EF Core ä¹è§‚é”ï¼Œè®©ä½ çš„ç³»ç»Ÿåœ¨é¢å¯¹ç¬æ—¶é«˜å¹¶å‘æ—¶ä¾ç„¶ç¨³å®šå¯é ï¼Œä¸ºä¸šåŠ¡åˆ›æ–°ä¿é©¾æŠ¤èˆªï¼
