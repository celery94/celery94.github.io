---
pubDatetime: 2025-04-12 11:26:25
tags: ["Productivity", "Tools", "Testing"]
slug: testing-signalr-applications-with-integration-tests
source: https://www.jocheojeda.com/2025/04/02/testing-signalr-applications-with-integration-tests/
title: ğŸš€é€šè¿‡é›†æˆæµ‹è¯•å…¨é¢æµ‹è¯•SignalRåº”ç”¨ç¨‹åºï¼šä»è®¾ç½®åˆ°éªŒè¯çš„å®Œæ•´æŒ‡å—
description: å­¦ä¹ å¦‚ä½•ä½¿ç”¨æµ‹è¯•é©±åŠ¨å¼€å‘ï¼ˆTDDï¼‰æ–¹æ³•æµ‹è¯•SignalRå®æ—¶é€šä¿¡åº”ç”¨ç¨‹åºï¼Œé€šè¿‡é›†æˆæµ‹è¯•ç¡®ä¿ä»£ç è´¨é‡ä¸åŠŸèƒ½ä¸€è‡´æ€§ã€‚æ–‡ç« åŒ…å«è¯¦ç»†çš„ä»£ç ç¤ºä¾‹å’Œå®é™…æ“ä½œæ­¥éª¤ï¼ŒåŠ©åŠ›å¼€å‘äººå‘˜é«˜æ•ˆæµ‹è¯•ä¸ä¼˜åŒ–SignalRåº”ç”¨ã€‚
---

# ğŸš€é€šè¿‡é›†æˆæµ‹è¯•å…¨é¢æµ‹è¯•SignalRåº”ç”¨ç¨‹åºï¼šä»è®¾ç½®åˆ°éªŒè¯çš„å®Œæ•´æŒ‡å—

åœ¨ç°ä»£è½¯ä»¶å¼€å‘ä¸­ï¼Œå®æ—¶é€šä¿¡åº”ç”¨ç¨‹åºçš„è´¨é‡ä¿è¯è‡³å…³é‡è¦ã€‚æœ¬æ–‡å°†å¸¦ä½ æ·±å…¥æ¢ç´¢å¦‚ä½•é€šè¿‡é›†æˆæµ‹è¯•éªŒè¯SignalRåº”ç”¨ç¨‹åºçš„åŠŸèƒ½ä¸ä¸€è‡´æ€§ï¼Œç»“åˆæµ‹è¯•é©±åŠ¨å¼€å‘ï¼ˆTDDï¼‰æ–¹æ³•ï¼Œè®©å¼€å‘è¿‡ç¨‹æ›´é«˜æ•ˆã€æ›´å¯é ã€‚

## ğŸ’¡ ä¸ºä»€ä¹ˆé€‰æ‹©é›†æˆæµ‹è¯•ï¼Ÿ

åœ¨å¼€å‘SignalRåº”ç”¨ç¨‹åºæ—¶ï¼Œæµ‹è¯•ä¸ä»…å¸®åŠ©æˆ‘ä»¬éªŒè¯åŠŸèƒ½ï¼Œè¿˜èƒ½ä¿éšœä»£ç åœ¨é‡æ„æ—¶çš„ç¨³å®šæ€§ã€‚ä¸ä¼ ç»Ÿçš„å•å…ƒæµ‹è¯•ç›¸æ¯”ï¼Œé›†æˆæµ‹è¯•æ›´æ³¨é‡æ•´ä¸ªç³»ç»Ÿçš„äº¤äº’ï¼ŒåŒ…æ‹¬æ•°æ®åº“ã€APIå’Œå®æ—¶é€šä¿¡çš„ååŒå·¥ä½œã€‚è¿™ç§æ–¹æ³•å°¤å…¶é€‚åˆåƒSignalRè¿™æ ·çš„å®æ—¶é€šä¿¡æ¡†æ¶ã€‚

### å•å…ƒæµ‹è¯• VS é›†æˆæµ‹è¯•

- **å•å…ƒæµ‹è¯•**ï¼šä¸“æ³¨äºå•ä¸€æ¨¡å—çš„åŠŸèƒ½ï¼Œé€šå¸¸é€šè¿‡æ¨¡æ‹Ÿä¾èµ–æ¥è¿›è¡Œéš”ç¦»æµ‹è¯•ã€‚
- **é›†æˆæµ‹è¯•**ï¼šå…³æ³¨å¤šä¸ªç»„ä»¶ä¹‹é—´çš„äº¤äº’ï¼ŒéªŒè¯ç³»ç»Ÿæ•´ä½“åŠŸèƒ½æ˜¯å¦æ­£å¸¸è¿è¡Œã€‚

åœ¨SignalRåº”ç”¨ä¸­ï¼Œé€šè¿‡é›†æˆæµ‹è¯•å¯ä»¥æ¨¡æ‹Ÿç”¨æˆ·å‘é€æ¶ˆæ¯ã€æ¥æ”¶æ¶ˆæ¯ç­‰çœŸå®åœºæ™¯ï¼Œä»è€Œæ›´å…¨é¢åœ°éªŒè¯ä»£ç é€»è¾‘ã€‚

---

## ğŸ”§ å¦‚ä½•è®¾ç½®é›†æˆæµ‹è¯•ç¯å¢ƒ

åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬å°†åˆ›å»ºä¸€ä¸ªä¸“é—¨ç”¨äºSignalRé›†æˆæµ‹è¯•çš„æœåŠ¡å™¨ï¼Œå¹¶é€šè¿‡è¯¥æœåŠ¡å™¨æ¨¡æ‹Ÿæ¶ˆæ¯å‘é€å’Œæ¥æ”¶åœºæ™¯ã€‚

### ğŸ› ï¸ åˆ›å»ºæµ‹è¯•æœåŠ¡å™¨

é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦è®¾ç½®ä¸€ä¸ªæµ‹è¯•ä¸»æœºï¼ˆTest Hostï¼‰ï¼Œå®ƒèƒ½å¤Ÿæ¨¡æ‹ŸSignalRçš„è¿è¡Œç¯å¢ƒã€‚ä»¥ä¸‹æ˜¯è®¾ç½®ä»£ç ï¼š

```csharp
// ARRANGE
var hostBuilder = new HostBuilder()
    .ConfigureWebHost(webHost =>
    {
        webHost.UseTestServer();
        webHost.UseStartup<Startup>();
    });

var host = await hostBuilder.StartAsync();
var server = host.GetTestServer();
```

è¿™æ®µä»£ç å®Œæˆäº†ä»¥ä¸‹ä»»åŠ¡ï¼š

- ä½¿ç”¨ `HostBuilder` é…ç½®æµ‹è¯•ä¸»æœºã€‚
- ä½¿ç”¨ `UseTestServer` æ–¹æ³•åˆ›å»ºä¸€ä¸ªä¸“å±æµ‹è¯•æœåŠ¡å™¨ã€‚

### ğŸ¤ å¤„ç†SignalRè¿æ¥

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬é…ç½®SignalRè¿æ¥ï¼Œè®©å®ƒèƒ½å¤Ÿä¸æµ‹è¯•æœåŠ¡å™¨äº¤äº’ï¼š

```csharp
var connection = new HubConnectionBuilder()
    .WithUrl("http://localhost/chathub", options =>
    {
        options.HttpMessageHandlerFactory = _ => server.CreateHandler();
    })
    .Build();

string receivedUser = null;
string receivedMessage = null;

// è®¾ç½®æ¶ˆæ¯æ¥æ”¶å¤„ç†é€»è¾‘
connection.On<string, string>("ReceiveMessage", (user, message) =>
{
    receivedUser = user;
    receivedMessage = message;
});
```

é€šè¿‡ `HubConnectionBuilder` é…ç½®SignalRè¿æ¥ï¼Œå¹¶ä½¿ç”¨ `CreateHandler()` æ–¹æ³•è®©è¯·æ±‚æŒ‡å‘æµ‹è¯•æœåŠ¡å™¨ã€‚æ¥ç€ï¼Œé€šè¿‡ `On` æ–¹æ³•è®¾ç½®æ¶ˆæ¯æ¥æ”¶é€»è¾‘ï¼Œç”¨äºéªŒè¯å‘é€å’Œæ¥æ”¶æ˜¯å¦æ­£å¸¸å·¥ä½œã€‚

---

## ğŸš€ å¼€å§‹æµ‹è¯•ï¼šå‘é€ä¸æ¥æ”¶æ¶ˆæ¯

ä»¥ä¸‹ä»£ç å±•ç¤ºäº†å®Œæ•´çš„æµ‹è¯•æµç¨‹ï¼Œä»å‘é€æ¶ˆæ¯åˆ°éªŒè¯æ¥æ”¶ç»“æœï¼š

```csharp
// ACT
await connection.StartAsync(); // å¯åŠ¨è¿æ¥
await connection.InvokeAsync("SendMessage", "TestUser", "Hello SignalR"); // å‘é€æ¶ˆæ¯

// ç­‰å¾…æ¶ˆæ¯å¤„ç†å®Œæˆ
await Task.Delay(100);

// ASSERT
Assert.That("TestUser" == receivedUser); // éªŒè¯ç”¨æˆ·ä¿¡æ¯
Assert.That("Hello SignalR" == receivedMessage); // éªŒè¯æ¶ˆæ¯å†…å®¹

// æ¸…ç†èµ„æº
await connection.DisposeAsync();
```

è¯¥æµç¨‹åŒ…æ‹¬ä»¥ä¸‹æ­¥éª¤ï¼š

1. å¯åŠ¨SignalRè¿æ¥ã€‚
2. é€šè¿‡ `InvokeAsync` æ–¹æ³•å‘æœåŠ¡å™¨å‘é€æ¶ˆæ¯ã€‚
3. ä½¿ç”¨æ–­è¨€æ£€æŸ¥æ¥æ”¶åˆ°çš„ç”¨æˆ·å’Œæ¶ˆæ¯æ˜¯å¦ç¬¦åˆé¢„æœŸã€‚

---

## ğŸ”— å®Œæ•´ä»£ç ç¤ºä¾‹

å¦‚æœä½ å¯¹å®Œæ•´å®ç°æ„Ÿå…´è¶£ï¼Œå¯ä»¥è®¿é—® [GitHubä»“åº“](https://github.com/egarim/TestingSignalR/blob/master/UnitTest1.cs)ï¼Œè·å–æ‰€æœ‰ä»£ç ç»†èŠ‚ã€‚

---

## ğŸŒŸ æ€»ç»“ä¸å±•æœ›

é€šè¿‡æœ¬æ–‡ï¼Œä½ å­¦åˆ°äº†å¦‚ä½•åˆ©ç”¨é›†æˆæµ‹è¯•éªŒè¯SignalRåº”ç”¨ç¨‹åºçš„æ ¸å¿ƒåŠŸèƒ½ï¼ŒåŒ…æ‹¬æ¶ˆæ¯å‘é€ä¸æ¥æ”¶ã€‚åœ¨å®é™…å¼€å‘ä¸­ï¼Œè¿™ç§æ–¹æ³•ä¸ä»…æå‡äº†ä»£ç è´¨é‡ï¼Œä¹Ÿèƒ½å¸®åŠ©ä½ å¿«é€Ÿå®šä½é—®é¢˜ï¼Œæé«˜å¼€å‘æ•ˆç‡ã€‚

ğŸ’¬ å¦‚æœä½ è¿˜æœ‰ä»»ä½•å…³äºSignalRæˆ–é›†æˆæµ‹è¯•çš„é—®é¢˜ï¼Œæ¬¢è¿ç•™è¨€äº¤æµï¼ä¸€èµ·æ¢ç´¢æ›´å¤šå®æ—¶é€šä¿¡æŠ€æœ¯çš„å¯èƒ½æ€§ï¼

---

ğŸ‘ å–œæ¬¢è¿™ç¯‡æ–‡ç« çš„è¯ï¼Œè¯·åˆ†äº«ç»™ä½ çš„åŒè¡Œæœ‹å‹ï¼Œè®©æˆ‘ä»¬ä¸€èµ·æå‡æŠ€æœ¯æ°´å¹³ï¼
