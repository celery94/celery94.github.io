---
pubDatetime: 2025-03-30 18:52:03
tags: ["AI", "Productivity"]
slug: domain-events-loosely-coupled-systems
source: è‡ªåª’ä½“åŸåˆ›
title: ä»é¢†åŸŸäº‹ä»¶åˆ°æ¾è€¦åˆç³»ç»Ÿï¼šå¦‚ä½•ç”¨EF Coreå’ŒMediatRæ„å»ºé«˜æ•ˆæ¶æ„
description: æ¢è®¨é¢†åŸŸäº‹ä»¶åœ¨æ„å»ºæ¾è€¦åˆç³»ç»Ÿä¸­çš„æ ¸å¿ƒä½œç”¨ï¼Œè¯¦ç»†åˆ†æå…¶å®ç°æ–¹æ³•ã€æŠ€æœ¯å·¥å…·ä»¥åŠä¸€è‡´æ€§é—®é¢˜çš„è§£å†³æ–¹æ¡ˆï¼ŒåŠ©åŠ›æŠ€æœ¯å¼€å‘è€…ä¼˜åŒ–ç³»ç»Ÿæ¶æ„ã€‚
---

# ä»é¢†åŸŸäº‹ä»¶åˆ°æ¾è€¦åˆç³»ç»Ÿï¼šå¦‚ä½•ç”¨EF Coreå’ŒMediatRæ„å»ºé«˜æ•ˆæ¶æ„

åœ¨è½¯ä»¶å¼€å‘ä¸­ï¼Œ**å¦‚ä½•æ„å»ºæ¾è€¦åˆçš„ç³»ç»Ÿ**ä¸€ç›´æ˜¯æŠ€æœ¯é¢†åŸŸçš„çƒ­é—¨è¯é¢˜ï¼Œä¹Ÿæ˜¯ç³»ç»Ÿæ¶æ„è®¾è®¡ä¸­çš„æ ¸å¿ƒæŒ‘æˆ˜ä¹‹ä¸€ã€‚éšç€é¢†åŸŸé©±åŠ¨è®¾è®¡ï¼ˆDDDï¼‰çš„æµè¡Œï¼Œé¢†åŸŸäº‹ä»¶ï¼ˆDomain Eventsï¼‰ä½œä¸ºä¸€ç§é‡è¦çš„æˆ˜æœ¯æ¨¡å¼ï¼Œè¶Šæ¥è¶Šå—åˆ°æŠ€æœ¯å¼€å‘è€…çš„é’çã€‚ä»Šå¤©ï¼Œæˆ‘ä»¬å°†æ·±å…¥æ¢è®¨é¢†åŸŸäº‹ä»¶çš„å®šä¹‰ã€å®ç°æ–¹å¼ä»¥åŠç›¸å…³æŠ€æœ¯å·¥å…·ï¼ˆEF Coreå’ŒMediatRï¼‰çš„åº”ç”¨ï¼Œå¸®åŠ©æ‚¨è½»æ¾æ„å»ºé«˜æ•ˆæ¾è€¦åˆç³»ç»Ÿã€‚

---

## ä»€ä¹ˆæ˜¯é¢†åŸŸäº‹ä»¶ï¼ŸğŸ¤”

### å®šä¹‰ä¸ä½œç”¨

é¢†åŸŸäº‹ä»¶æ˜¯æŒ‡åœ¨æŸä¸ªé¢†åŸŸä¸­å·²ç»å‘ç”Ÿçš„**äº‹å®**ï¼Œå®ƒä¸å¯æ›´æ”¹ï¼Œæ˜¯ç³»ç»Ÿä¸šåŠ¡é€»è¾‘çš„è‡ªç„¶è¾“å‡ºã€‚é€šè¿‡é¢†åŸŸäº‹ä»¶ï¼Œæˆ‘ä»¬å¯ä»¥æ˜¾å¼åœ°è¡¨è¾¾ä¸šåŠ¡é€»è¾‘ä¸­çš„å‰¯ä½œç”¨ï¼Œå¹¶å®ç°å¤šä¸ªèšåˆä¹‹é—´çš„è§£è€¦ã€‚

### æ ¸å¿ƒä¼˜åŠ¿

- **åˆ†ç¦»å…³æ³¨ç‚¹**ï¼šå°†æ ¸å¿ƒé¢†åŸŸé€»è¾‘ä¸å‰¯ä½œç”¨å¤„ç†åˆ†ç¦»ï¼Œæé«˜ä»£ç çš„å¯ç»´æŠ¤æ€§ã€‚
- **è§¦å‘è·¨èšåˆçš„å‰¯ä½œç”¨**ï¼šæ”¯æŒå†…éƒ¨å¤šä¸ªèšåˆä¹‹é—´çš„é€šä¿¡ã€‚
- **æå‡å¯æ‰©å±•æ€§**ï¼šé€šè¿‡è®¢é˜…é¢†åŸŸäº‹ä»¶ï¼Œå¯ä»¥è½»æ¾åœ°æ‰©å±•ç³»ç»ŸåŠŸèƒ½ã€‚

---

## é¢†åŸŸäº‹ä»¶ VS é›†æˆäº‹ä»¶ ğŸ“¤

è™½ç„¶é¢†åŸŸäº‹ä»¶ä¸é›†æˆäº‹ä»¶åœ¨è¯­ä¹‰ä¸Šéƒ½è¡¨ç¤ºè¿‡å»å‘ç”Ÿçš„äº‹æƒ…ï¼Œä½†å®ƒä»¬çš„**æ„å›¾å’Œåº”ç”¨åœºæ™¯**æœ‰æ‰€ä¸åŒï¼š

| ç‰¹æ€§         | é¢†åŸŸäº‹ä»¶           | é›†æˆäº‹ä»¶                      |
| ------------ | ------------------ | ----------------------------- |
| **é€‚ç”¨èŒƒå›´** | å•ä¸€é¢†åŸŸå†…         | è·¨å­ç³»ç»Ÿã€å¾®æœåŠ¡              |
| **ä¼ è¾“æ–¹å¼** | å†…å­˜æ¶ˆæ¯æ€»çº¿       | æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆå¦‚RabbitMQã€Kafkaï¼‰ |
| **å¤„ç†æ–¹å¼** | åŒæ­¥æˆ–å¼‚æ­¥         | å®Œå…¨å¼‚æ­¥                      |
| **ç›®çš„**     | è§¦å‘é¢†åŸŸå†…çš„å‰¯ä½œç”¨ | é€šçŸ¥å…¶ä»–ç³»ç»Ÿ                  |

ç¤ºä¾‹ï¼šé¢†åŸŸäº‹ä»¶å¯ä»¥ç”¨æ¥æ›´æ–°è®¢å•çŠ¶æ€ï¼Œè€Œé›†æˆäº‹ä»¶åˆ™å¯ä»¥é€šçŸ¥åº“å­˜ç³»ç»Ÿå‡å°‘åº“å­˜ã€‚

---

## å¦‚ä½•å®ç°é¢†åŸŸäº‹ä»¶ ğŸŒŸ

### è®¾è®¡é¢†åŸŸäº‹ä»¶çš„åŸºæœ¬åŸåˆ™

1. **ä¸å¯å˜æ€§**ï¼šé¢†åŸŸäº‹ä»¶æ˜¯äº‹å®ï¼Œåº”è¯¥å…·å¤‡ä¸å¯å˜æ€§ã€‚
2. **å‘½åçº¦å®š**ï¼šä½¿ç”¨è¿‡å»æ—¶æ€å‘½åäº‹ä»¶ï¼Œä¾‹å¦‚`OrderCompletedDomainEvent`ã€‚
3. **ä¿¡æ¯è®¾è®¡**ï¼šæ ¹æ®ä¸šåŠ¡éœ€æ±‚å†³å®šé¢†åŸŸäº‹ä»¶çš„â€œèƒ–ç˜¦â€ï¼Œå³äº‹ä»¶ä¸­åŒ…å«çš„ä¿¡æ¯é‡ã€‚

#### ç¤ºä¾‹ä»£ç ï¼šå®šä¹‰é¢†åŸŸäº‹ä»¶

ä½¿ç”¨`MediatR`åº“å®ç°é¢†åŸŸäº‹ä»¶çš„æŠ½è±¡ï¼š

```csharp
using MediatR;

public interface IDomainEvent : INotification
{
}
```

å®šä¹‰å…·ä½“çš„é¢†åŸŸäº‹ä»¶ï¼š

```csharp
public class CourseCompletedDomainEvent : IDomainEvent
{
    public Guid CourseId { get; init; }
}
```

---

## ä»é¢†åŸŸä¸­è§¦å‘äº‹ä»¶ ğŸš€

### å®ç°é¢†åŸŸäº‹ä»¶çš„è§¦å‘æœºåˆ¶

é€šè¿‡åˆ›å»ºä¸€ä¸ª`Entity`åŸºç±»æ¥ç®¡ç†é¢†åŸŸäº‹ä»¶çš„è§¦å‘å’Œå­˜å‚¨ï¼š

```csharp
public abstract class Entity : IEntity
{
    private readonly List<IDomainEvent> _domainEvents = new();

    public IReadOnlyList<IDomainEvent> GetDomainEvents()
    {
        return _domainEvents.ToList();
    }

    public void ClearDomainEvents()
    {
        _domainEvents.Clear();
    }

    protected void RaiseDomainEvent(IDomainEvent domainEvent)
    {
        _domainEvents.Add(domainEvent);
    }
}
```

åœ¨å®ä½“ä¸­è§¦å‘é¢†åŸŸäº‹ä»¶ï¼š

```csharp
public class Course : Entity
{
    public Guid Id { get; private set; }

    public void Complete()
    {
        RaiseDomainEvent(new CourseCompletedDomainEvent { CourseId = this.Id });
    }
}
```

---

## ä½¿ç”¨EF Coreå‘å¸ƒé¢†åŸŸäº‹ä»¶ ğŸ“¡

EF Coreä½œä¸ºä¸€ä¸ªå¼ºå¤§çš„ORMå·¥å…·ï¼Œå¯ä»¥ç”¨æ¥å‘å¸ƒé¢†åŸŸäº‹ä»¶ã€‚é€šè¿‡é‡å†™`SaveChangesAsync`æ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ä¿å­˜æ•°æ®åº“è®°å½•åå‘å¸ƒé¢†åŸŸäº‹ä»¶ã€‚

### å‘å¸ƒæ—¶æœºçš„é€‰æ‹©

1. **ä¿å­˜å‰**ï¼šé¢†åŸŸäº‹ä»¶ä¸æ•°æ®åº“ä¿å­˜å…±äº«äº‹åŠ¡ï¼Œä¿è¯ç«‹å³ä¸€è‡´æ€§ã€‚
2. **ä¿å­˜å**ï¼šé¢†åŸŸäº‹ä»¶å•ç‹¬äº‹åŠ¡ï¼Œæ”¯æŒæœ€ç»ˆä¸€è‡´æ€§ï¼ˆæ¨èï¼‰ã€‚

#### ç¤ºä¾‹ä»£ç ï¼šå‘å¸ƒé¢†åŸŸäº‹ä»¶

```csharp
public class ApplicationDbContext : DbContext
{
    public override async Task<int> SaveChangesAsync(
        CancellationToken cancellationToken = default)
    {
        var result = await base.SaveChangesAsync(cancellationToken);
        await PublishDomainEventsAsync();
        return result;
    }

    private async Task PublishDomainEventsAsync()
    {
        var domainEvents = ChangeTracker
            .Entries<Entity>()
            .Select(entry => entry.Entity)
            .SelectMany(entity =>
            {
                var domainEvents = entity.GetDomainEvents();
                entity.ClearDomainEvents();
                return domainEvents;
            })
            .ToList();

        foreach (var domainEvent in domainEvents)
        {
            await _publisher.Publish(domainEvent);
        }
    }
}
```

---

## ä½¿ç”¨MediatRå¤„ç†é¢†åŸŸäº‹ä»¶ ğŸ› ï¸

MediatRæä¾›äº†æ–¹ä¾¿çš„å‘å¸ƒ-è®¢é˜…æ¨¡å¼ï¼Œå¯ä»¥è½»æ¾å®ç°é¢†åŸŸäº‹ä»¶çš„å¤„ç†é€»è¾‘ã€‚

### ç¤ºä¾‹ä»£ç ï¼šäº‹ä»¶å¤„ç†å™¨

```csharp
public class CourseCompletedDomainEventHandler
    : INotificationHandler<CourseCompletedDomainEvent>
{
    private readonly IBus _bus;

    public CourseCompletedDomainEventHandler(IBus bus)
    {
        _bus = bus;
    }

    public async Task Handle(
        CourseCompletedDomainEvent domainEvent,
        CancellationToken cancellationToken)
    {
        await _bus.Publish(
            new CourseCompletedIntegrationEvent(domainEvent.CourseId),
            cancellationToken);
    }
}
```

---

## ä¸€è‡´æ€§é—®é¢˜ä¸Outboxæ¨¡å¼ ğŸ“¦

### ä¸ºä»€ä¹ˆéœ€è¦Outboxæ¨¡å¼ï¼Ÿ

åœ¨é¢†åŸŸäº‹ä»¶å‘å¸ƒåï¼Œå¦‚æœäº‹ä»¶å¤„ç†å¤±è´¥å¯èƒ½å¯¼è‡´ç³»ç»ŸçŠ¶æ€çš„ä¸ä¸€è‡´ã€‚Outboxæ¨¡å¼é€šè¿‡å°†äº‹ä»¶å­˜å‚¨åˆ°æ•°æ®åº“çš„å•ç‹¬è¡¨ä¸­ï¼Œç¡®ä¿é¢†åŸŸäº‹ä»¶ä¸ä¸šåŠ¡æ•°æ®çš„åŸå­æ€§ã€‚

### Outboxæ¨¡å¼çš„å·¥ä½œæµç¨‹

1. åœ¨æ•°æ®åº“ä¸­ä¿å­˜ä¸šåŠ¡æ•°æ®å’Œé¢†åŸŸäº‹ä»¶ã€‚
2. ä½¿ç”¨åå°ä»»åŠ¡å¼‚æ­¥å¤„ç†äº‹ä»¶ã€‚
3. ç¡®ä¿äº‹ä»¶çš„å¯é äº¤ä»˜ã€‚

---

## ç»“å°¾æ€»ç»“ ğŸ™Œ

é¢†åŸŸäº‹ä»¶æ˜¯æ„å»ºæ¾è€¦åˆç³»ç»Ÿçš„é‡è¦å·¥å…·ï¼Œèƒ½æœ‰æ•ˆåˆ†ç¦»æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ä¸å‰¯ä½œç”¨å¤„ç†ã€‚é€šè¿‡ç»“åˆEF Coreå’ŒMediatRï¼Œæˆ‘ä»¬å¯ä»¥è½»æ¾å®ç°é¢†åŸŸäº‹ä»¶çš„å‘å¸ƒä¸è®¢é˜…ã€‚è™½ç„¶é¢†åŸŸäº‹ä»¶çš„æœ€ç»ˆä¸€è‡´æ€§å¸¦æ¥äº†æŒ‘æˆ˜ï¼Œä½†ä½¿ç”¨Outboxæ¨¡å¼å¯ä»¥å¾ˆå¥½åœ°è§£å†³è¿™ä¸€é—®é¢˜ã€‚

### äº’åŠ¨ç¯èŠ‚ ğŸ¯

ä½ è®¤ä¸ºé¢†åŸŸäº‹ä»¶åœ¨æ„å»ºåˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„æœªæ¥åº”ç”¨åœºæ™¯æœ‰å“ªäº›ï¼Ÿæ¬¢è¿åœ¨è¯„è®ºåŒºç•™è¨€è®¨è®ºï¼

ğŸ‘‰ å¦‚æœä½ å–œæ¬¢è¿™ç¯‡æ–‡ç« ï¼Œè®°å¾—ç‚¹èµã€æ”¶è—å¹¶åˆ†äº«ç»™ä½ çš„å¼€å‘æœ‹å‹ä»¬ï¼

ğŸš€ æ›´å¤šæŠ€æœ¯å¹²è´§ï¼Œæ¬¢è¿å…³æ³¨æˆ‘ä»¬çš„å…¬ä¼—å·ï¼
