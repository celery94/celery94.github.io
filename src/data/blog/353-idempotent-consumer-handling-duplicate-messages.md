---
pubDatetime: 2025-06-03
tags: ["Productivity", "Tools"]
slug: idempotent-consumer-handling-duplicate-messages
source: https://www.milanjovanovic.tech/blog/idempotent-consumer-handling-duplicate-messages
title: å¹‚ç­‰æ€§æ¶ˆè´¹è€…æ¨¡å¼ï¼šå¦‚ä½•ä¼˜é›…åº”å¯¹åˆ†å¸ƒå¼æ¶ˆæ¯é‡å¤å¤„ç†ï¼Ÿ
description: åœ¨äº‹ä»¶é©±åŠ¨å’Œåˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œæ¶ˆæ¯é‡å¤å¤„ç†å¯èƒ½å¸¦æ¥ç¾éš¾æ€§çš„åŽæžœã€‚æœ¬æ–‡ä»¥å¼€å‘è€…è§†è§’ï¼Œæ·±å…¥å‰–æžå¹‚ç­‰æ€§æ¶ˆè´¹è€…ï¼ˆIdempotent Consumerï¼‰æ¨¡å¼çš„åŽŸç†ã€å®žçŽ°æ–¹å¼ä¸Žæƒè¡¡ï¼ŒåŠ©ä½ æž„å»ºæ›´åŠ å¥å£®å¯é çš„æ¶ˆæ¯ç³»ç»Ÿã€‚
---

# å¹‚ç­‰æ€§æ¶ˆè´¹è€…æ¨¡å¼ï¼šå¦‚ä½•ä¼˜é›…åº”å¯¹åˆ†å¸ƒå¼æ¶ˆæ¯é‡å¤å¤„ç†ï¼ŸðŸš€

## å¼•è¨€ï¼šä¸ºä»€ä¹ˆè¦å…³æ³¨æ¶ˆæ¯é‡å¤ï¼Ÿ

åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿå’Œäº‹ä»¶é©±åŠ¨æž¶æž„ä¸­ï¼Œæ¶ˆæ¯é˜Ÿåˆ—å¯é æ€§æ˜¯ç³»ç»Ÿå¥å£®æ€§çš„åŸºçŸ³ã€‚ç„¶è€Œä½ æ˜¯å¦é‡åˆ°è¿‡è¿™æ ·çš„æƒ…å†µâ€”â€”**åŒä¸€æ¡æ¶ˆæ¯è¢«å¤„ç†äº†ä¸¤æ¬¡**ï¼Ÿæ¯”å¦‚ä¸€æ¬¡æ”¯ä»˜è¯·æ±‚è¢«é‡å¤æ‰§è¡Œï¼Œå¯¼è‡´ç”¨æˆ·è´¦æˆ·è¢«å¤šæ‰£äº†ä¸€ç¬”é’±ã€‚æƒ³è±¡ä¸€ä¸‹ï¼Œå¦‚æžœä½ çš„é“¶è¡Œè´¦æˆ·è¢«åŒå€æ‰£æ¬¾ï¼Œé‚£åŽæžœå°†ä¸å ªè®¾æƒ³ï¼ðŸ˜±

å®žé™…ä¸Šï¼Œç”±äºŽç½‘ç»œæ³¢åŠ¨ã€æœåŠ¡é‡è¯•æˆ–ä¸­é—´ä»¶æ•…éšœï¼Œæ¶ˆæ¯**è¢«å¤šæ¬¡æŠ•é€’å’Œå¤„ç†çš„æƒ…å†µæ¯”æˆ‘ä»¬æƒ³è±¡å¾—è¿˜è¦é¢‘ç¹**ã€‚å¦‚ä½•é¿å…é‡å¤æ¶ˆè´¹å¸¦æ¥çš„å‰¯ä½œç”¨ï¼Œæˆä¸ºæ¯ä¸ªåŽç«¯å¼€å‘è€…å’Œæž¶æž„å¸ˆéƒ½æ— æ³•å›žé¿çš„é—®é¢˜ã€‚

äºŽæ˜¯ï¼Œä»Šå¤©æˆ‘ä»¬å°±æ¥èŠèŠ**å¹‚ç­‰æ€§æ¶ˆè´¹è€…ï¼ˆIdempotent Consumerï¼‰æ¨¡å¼**ï¼Œå®ƒæ˜¯å¦‚ä½•å¸®æˆ‘ä»¬è§£å†³è¿™ä¸€éš¾é¢˜çš„ã€‚

## å¹‚ç­‰æ€§æ¶ˆè´¹è€…æ¨¡å¼åŽŸç†å…¨è§£

### ä»€ä¹ˆæ˜¯å¹‚ç­‰æ€§ï¼Ÿä¸ºä»€ä¹ˆåœ¨æ¶ˆæ¯é˜Ÿåˆ—ä¸­å¦‚æ­¤é‡è¦ï¼Ÿ

> **å¹‚ç­‰æ“ä½œ**ï¼šæ— è®ºåŒä¸€æ“ä½œæ‰§è¡Œå¤šå°‘æ¬¡ï¼Œç»“æžœéƒ½ä¿æŒä¸€è‡´ï¼Œæ— å‰¯ä½œç”¨ã€‚

åœ¨ç†æƒ³æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¸Œæœ›æ¶ˆæ¯ç³»ç»Ÿæ”¯æŒ**Exactly-onceï¼ˆæ°å¥½ä¸€æ¬¡ï¼‰**æŠ•é€’ï¼Œä½†çŽ°å®žä¸­ç»å¤§å¤šæ•°ä¸­é—´ä»¶åªæ”¯æŒ**At-least-onceï¼ˆè‡³å°‘ä¸€æ¬¡ï¼‰**ã€‚è¿™æ„å‘³ç€ä½ è¦åšå¥½é‡å¤æ¶ˆè´¹çš„å¿ƒç†å‡†å¤‡ã€‚

å¹‚ç­‰æ€§æ¶ˆè´¹è€…æ¨¡å¼ï¼Œå°±æ˜¯è®©æˆ‘ä»¬çš„ä¸šåŠ¡å¤„ç†é€»è¾‘â€œæœ‰è®°å¿†â€â€”â€”å³ä½¿æ”¶åˆ°äº†é‡å¤çš„æ¶ˆæ¯ï¼Œä¹Ÿåªä¼šäº§ç”Ÿä¸€æ¬¡å½±å“ã€‚

### å®žçŽ°æ€è·¯ä¸Žæ ¸å¿ƒç®—æ³•

æ•´ä¸ªæµç¨‹å½’çº³ä¸ºå››ä¸ªæ­¥éª¤ï¼š

1. åˆ¤æ–­æ¶ˆæ¯æ˜¯å¦å·²ç»å¤„ç†è¿‡ï¼ˆé€šå¸¸é€šè¿‡å”¯ä¸€æ ‡è¯†IDï¼‰
2. å¦‚æžœå·²å¤„ç†ï¼Œåˆ™ç›´æŽ¥å¿½ç•¥
3. å¦‚æžœæœªå¤„ç†ï¼Œåˆ™æ‰§è¡Œä¸šåŠ¡é€»è¾‘
4. å¤„ç†å®ŒåŽï¼Œè®°å½•è¯¥æ¶ˆæ¯å·²è¢«æ¶ˆè´¹

![å¹‚ç­‰æ€§æ¶ˆè´¹è€…ç®—æ³•ç¤ºæ„å›¾](https://www.milanjovanovic.tech/blogs/mnw_034/idempotent_consumer_algorithm.png?imwidth=828)

è¿™å°±éœ€è¦æˆ‘ä»¬ä¸ºæ¯æ¡æ¶ˆæ¯åˆ†é…ä¸€ä¸ª**å”¯ä¸€ID**ï¼Œå¹¶åœ¨æ•°æ®åº“ä¸­ä¸“é—¨ç»´æŠ¤ä¸€å¼ å·²å¤„ç†æ¶ˆæ¯çš„è¡¨ã€‚

## å¹‚ç­‰æ€§æ¶ˆè´¹è€…çš„ä¸¤ç§å®žçŽ°æ–¹å¼

### 1ï¸âƒ£ Lazy Idempotent Consumerï¼ˆæ‡’æƒ°åž‹ï¼‰

**ç­–ç•¥ï¼š** å…ˆå¤„ç†æ¶ˆæ¯ï¼Œå†è®°å½•å·²å¤„ç†IDã€‚åªæœ‰ä¸šåŠ¡é€»è¾‘æ‰§è¡ŒæˆåŠŸåŽï¼Œæ‰æ ‡è®°è¯¥æ¶ˆæ¯å·²æ¶ˆè´¹ã€‚å¼‚å¸¸æ—¶ï¼Œä¸è®°å½•IDï¼Œå…è®¸åŽç»­é‡è¯•ã€‚

**ä¼ªä»£ç å¦‚ä¸‹ï¼š**

```csharp
public async Task Handle(T message) {
    if (_messageRepository.IsProcessed(message.Id)) {
        return;
    }
    await _decorated.Handle(message); // æ‰§è¡Œä¸šåŠ¡é€»è¾‘
    _messageRepository.Store(message.Id); // æˆåŠŸåŽå­˜å‚¨ID
}
```

**ä¼˜ç‚¹ï¼š** å®žçŽ°ç®€å•ï¼Œé€»è¾‘æ¸…æ™°ï¼Œé¿å…å¤šä½™çš„æ•°æ®åº“æ“ä½œã€‚
**ç¼ºç‚¹ï¼š** é‡è¯•æœŸé—´å¯èƒ½äº§ç”Ÿå¹¶å‘é—®é¢˜ï¼Œéœ€è¦ä¿è¯äº‹åŠ¡ä¸€è‡´æ€§ã€‚

> æ›´å¤šç»†èŠ‚è§ï¼š[Lazy Idempotent Consumer](https://www.milanjovanovic.tech/blog/idempotent-consumer-handling-duplicate-messages#lazy-idempotent-consumer)

### 2ï¸âƒ£ Eager Idempotent Consumerï¼ˆæ€¥åˆ‡åž‹ï¼‰

**ç­–ç•¥ï¼š** å…ˆè®°å½•å·²å¤„ç†IDï¼Œå†æ‰§è¡Œä¸šåŠ¡é€»è¾‘ã€‚å¦‚æžœä¸šåŠ¡æŠ›å‡ºå¼‚å¸¸ï¼Œåˆ™éœ€å›žæ»šIDè®°å½•ï¼Œé¿å…è„æ•°æ®ã€‚

**ä¼ªä»£ç å¦‚ä¸‹ï¼š**

```csharp
public async Task Handle(T message) {
    try {
        if (_messageRepository.IsProcessed(message.Id)) {
            return;
        }
        _messageRepository.Store(message.Id); // å…ˆå­˜å‚¨ID
        await _decorated.Handle(message);
    } catch (Exception e) {
        _messageRepository.Remove(message.Id); // å¼‚å¸¸æ—¶å›žæ»šID
        throw;
    }
}
```

**ä¼˜ç‚¹ï¼š** é€‚åˆé«˜å¹¶å‘åœºæ™¯ï¼Œå¯å‡å°‘é‡å¤æ¶ˆè´¹æ¦‚çŽ‡ã€‚
**ç¼ºç‚¹ï¼š** å®žçŽ°æ›´å¤æ‚ï¼Œéœ€è¦æ³¨æ„æ•°æ®åº“åŽŸå­æ€§ä¸Žä¸€è‡´æ€§ã€‚

> æ›´å¤šç»†èŠ‚è§ï¼š[Eager Idempotent Consumer](https://www.milanjovanovic.tech/blog/idempotent-consumer-handling-duplicate-messages#eager-idempotent-consumer)

## åœºæ™¯é€‰æ‹©ä¸Žæƒè¡¡

- å¯¹äºŽå¤©ç„¶å¹‚ç­‰çš„æ“ä½œï¼ˆå¦‚å¿«ç…§è¦†ç›–ï¼‰ï¼Œæ— éœ€é¢å¤–å¤„ç†ã€‚
- å¯¹äºŽæ¶‰åŠèµ„é‡‘ã€åº“å­˜æ‰£å‡ã€é€šçŸ¥å‘é€ç­‰æ•æ„Ÿä¸šåŠ¡ï¼ŒåŠ¡å¿…å¼•å…¥å¹‚ç­‰æ€§ä¿éšœã€‚
- å¦‚æžœè¿½æ±‚ç®€å•æ˜“æ‡‚ã€ä¾¿äºŽç»´æŠ¤ï¼Œå¯ä»¥é¦–é€‰æ‡’æƒ°åž‹ã€‚
- å¦‚æžœé¢ä¸´é«˜å¹¶å‘å’Œä¸¥æ ¼ä¸€è‡´æ€§è¦æ±‚ï¼Œå¯ä»¥è€ƒè™‘æ€¥åˆ‡åž‹ï¼Œå¹¶é…åˆäº‹åŠ¡æœºåˆ¶ä¼˜åŒ–ã€‚

## ç»“è®ºä¸Žæ€è€ƒ

å¹‚ç­‰æ€§æ¶ˆè´¹è€…æ¨¡å¼ï¼Œæ˜¯æå‡äº‹ä»¶é©±åŠ¨å’Œåˆ†å¸ƒå¼ç³»ç»Ÿå¥å£®æ€§çš„å…³é”®æ­¦å™¨ã€‚å®ƒè®©æˆ‘ä»¬çš„ç³»ç»Ÿèƒ½å¤Ÿä»Žå®¹é¢å¯¹ä¸å¯é¢„æœŸçš„é‡å¤æŠ•é€’ï¼Œé¿å…â€œå‰¯ä½œç”¨ç¾éš¾â€ã€‚

ðŸ“ **å¼€å‘è€…å°ç»“ï¼š**

- æ˜Žç¡®å“ªäº›ä¸šåŠ¡éœ€è¦å¹‚ç­‰ä¿æŠ¤
- ç†è§£ä¸åŒå®žçŽ°æ–¹å¼çš„é€‚ç”¨åœºæ™¯ä¸Žä»£ä»·
- ä¸æ–­åœ¨å®žé™…é¡¹ç›®ä¸­ä¼˜åŒ–æ€§èƒ½ä¸Žä¸€è‡´æ€§æƒè¡¡

---

## äº’åŠ¨æ—¶é—´ ðŸŽ‰

ä½ åœ¨å®žé™…å¼€å‘ä¸­é‡åˆ°è¿‡å“ªäº›å› æ¶ˆæ¯é‡å¤å¯¼è‡´çš„å‘ï¼Ÿä½ æ›´åå¥½å“ªç§å¹‚ç­‰æ¶ˆè´¹è€…å®žçŽ°æ–¹å¼ï¼Ÿæ¬¢è¿Žåœ¨è¯„è®ºåŒºç•™è¨€äº¤æµï¼Œæˆ–è½¬å‘ç»™èº«è¾¹éœ€è¦çš„å°ä¼™ä¼´ï¼å¦‚æžœè§‰å¾—æ–‡ç« æœ‰ç”¨ï¼Œåˆ«å¿˜äº†ç‚¹èµžå’Œæ”¶è—å“¦ï½ž

---

> **å‚è€ƒé˜…è¯»ï¼š**
>
> - [åŽŸæ–‡é“¾æŽ¥ï¼šIdempotent Consumer - Handling Duplicate Messages](https://www.milanjovanovic.tech/blog/idempotent-consumer-handling-duplicate-messages)
> - [Clean Architectureå®žè·µ](https://www.milanjovanovic.tech/pragmatic-clean-architecture?utm_source=article_page)
> - [Modular Monolith Architecture](https://www.milanjovanovic.tech/modular-monolith-architecture?utm_source=article_page)
