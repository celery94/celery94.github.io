---
interface Props {
  headings: {
    depth: number;
    slug: string;
    text: string;
  }[];
}

const { headings } = Astro.props;
const filteredHeadings = headings.filter(h => h.depth <= 3);
---

{
  filteredHeadings.length > 0 && (
    <aside
      id="toc-aside"
      class="toc-aside hidden xl:block"
      aria-label="Table of Contents"
    >
      <nav class="toc-nav glass rounded-2xl border p-5">
        <h2 class="font-display mb-4 flex items-center gap-2 text-base font-semibold">
          <svg
            class="h-4 w-4 text-accent"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M4 6h16M4 12h16M4 18h7"
            />
          </svg>
          On This Page
        </h2>
        <ul class="space-y-1.5">
          {filteredHeadings.map(heading => (
            <li class:list={["toc-item", `toc-depth-${heading.depth}`]}>
              <a
                href={`#${heading.slug}`}
                class="toc-link focus-outline block rounded-lg px-3 py-2 text-sm text-foreground/80 transition-all duration-200 hover:bg-accent/8 hover:text-accent"
                style={`padding-left: ${0.65 + (heading.depth - 1) * 0.85}rem`}
                data-heading-id={heading.slug}
              >
                {heading.text}
              </a>
            </li>
          ))}
        </ul>
      </nav>
    </aside>
  )
}

<style>
  .toc-aside {
    position: fixed;
    top: 8rem;
    right: 1.8rem;
    width: 280px;
    max-height: calc(100vh - 10rem);
    overflow-y: auto;
    z-index: 15;
    padding-right: 0.35rem;
  }

  @media (min-width: 1920px) {
    .toc-aside {
      right: max(1.8rem, calc((100vw - 1536px) / 2));
    }
  }

  @media (max-width: 1460px) {
    .toc-aside {
      display: none;
    }
  }

  .toc-depth-2 {
    font-weight: 600;
  }

  .toc-depth-3 {
    opacity: 0.92;
  }

  .toc-link.active {
    color: var(--color-accent);
    background: color-mix(in srgb, var(--color-accent) 14%, transparent);
    box-shadow: inset 2px 0 0 color-mix(in srgb, var(--color-accent) 62%, transparent);
  }

  .toc-link.read {
    opacity: 0.72;
  }

  .toc-link.active.read {
    opacity: 1;
  }
</style>

<script>
  function initTableOfContents() {
    const headings = Array.from(
      document.querySelectorAll("#article h2[id], #article h3[id], #article h4[id]")
    );
    const tocLinks = Array.from(
      document.querySelectorAll(".toc-link")
    ) as HTMLElement[];

    if (headings.length === 0 || tocLinks.length === 0) return;

    const readHeadings = new Set<string>();

    const activeObserver = new IntersectionObserver(
      entries => {
        entries.forEach(entry => {
          const id = entry.target.getAttribute("id");
          if (!id || !entry.isIntersecting) return;

          readHeadings.add(id);

          tocLinks.forEach(link => {
            const linkId = link.getAttribute("data-heading-id");
            link.classList.remove("active");

            if (linkId === id) {
              link.classList.add("active");
            }

            if (readHeadings.has(linkId || "")) {
              link.classList.add("read");
            }
          });

          const activeLink = tocLinks.find(
            link => link.getAttribute("data-heading-id") === id
          );
          const tocAside = document.getElementById("toc-aside");
          if (activeLink && tocAside) {
            tocAside.scrollTo({
              top: activeLink.offsetTop - tocAside.clientHeight / 2 + activeLink.clientHeight / 2,
              behavior: "smooth",
            });
          }
        });
      },
      {
        rootMargin: "-110px 0px -65%",
        threshold: 0.5,
      }
    );

    headings.forEach(heading => activeObserver.observe(heading));

    tocLinks.forEach(link => {
      link.addEventListener("click", e => {
        e.preventDefault();
        const targetId = link.getAttribute("data-heading-id");
        const target = document.getElementById(targetId || "");
        if (!target) return;

        const offset = 96;
        const position = target.getBoundingClientRect().top + window.pageYOffset - offset;
        window.scrollTo({ top: position, behavior: "smooth" });
      });
    });
  }

  initTableOfContents();
  document.addEventListener("astro:after-swap", initTableOfContents);
</script>
