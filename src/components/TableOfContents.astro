---
interface Props {
  headings: {
    depth: number;
    slug: string;
    text: string;
  }[];
}

const { headings } = Astro.props;
const filteredHeadings = headings.filter(h => h.depth <= 3);
---

{
  filteredHeadings.length > 0 && (
    <aside
      id="toc-aside"
      class="toc-aside hidden xl:block"
      aria-label="Table of Contents"
    >
      <nav class="toc-nav border-accent/20 from-accent/5 to-accent/10 rounded-2xl border bg-gradient-to-br p-6 backdrop-blur-sm">
        <div class="mb-4 flex items-center gap-2">
          <svg
            class="text-accent h-5 w-5 flex-shrink-0"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M4 6h16M4 12h16M4 18h7"
            />
          </svg>
          <h2 class="text-accent text-lg font-bold">目录</h2>
        </div>
        <ul class="toc-list space-y-2">
          {filteredHeadings.map(heading => (
            <li class:list={["toc-item", `toc-depth-${heading.depth}`]}>
              <a
                href={`#${heading.slug}`}
                class="toc-link hover:bg-accent/10 hover:text-accent block rounded-lg px-3 py-2 text-sm transition-all duration-200 hover:translate-x-1"
                style={`padding-left: ${(heading.depth - 1) * 1}rem`}
                data-heading-id={heading.slug}
              >
                <span class="toc-bullet text-accent mr-2">▸</span>
                {heading.text}
              </a>
            </li>
          ))}
        </ul>
      </nav>
    </aside>
  )
}

<style>
  /* Fixed sidebar positioning */
  .toc-aside {
    position: fixed;
    top: 8rem;
    right: 2rem;
    width: 260px;
    max-height: calc(100vh - 10rem);
    overflow-y: auto;
    z-index: 10;
  }

  /* Ensure TOC stays at the rightmost edge on larger screens */
  @media (min-width: 1920px) {
    .toc-aside {
      right: max(2rem, calc((100vw - 1536px) / 2));
      width: 280px;
    }
  }

  /* Hide on smaller screens to avoid overlap */
  @media (max-width: 1400px) {
    .toc-aside {
      display: none;
    }
  }

  /* Scrollbar styling for TOC */
  .toc-aside::-webkit-scrollbar {
    width: 6px;
  }

  .toc-aside::-webkit-scrollbar-track {
    background: transparent;
  }

  :global(html[data-theme="dark"]) .toc-aside::-webkit-scrollbar-thumb {
    background: rgba(99, 102, 241, 0.4);
    border-radius: 3px;
  }

  :global(html[data-theme="dark"])
    .toc-aside::-webkit-scrollbar-thumb:hover {
    background: rgba(99, 102, 241, 0.6);
  }

  :global(html[data-theme="light"]) .toc-aside::-webkit-scrollbar-thumb {
    background: rgba(99, 102, 241, 0.3);
    border-radius: 3px;
  }

  :global(html[data-theme="light"])
    .toc-aside::-webkit-scrollbar-thumb:hover {
    background: rgba(99, 102, 241, 0.5);
  }

  /* TOC nav container */
  .toc-nav {
    position: relative;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
  }

  /* TOC items */
  .toc-item {
    list-style: none;
  }

  .toc-bullet {
    display: inline-block;
    transition: transform 0.2s ease;
  }

  .toc-item a:hover .toc-bullet {
    transform: translateX(4px);
  }

  .toc-depth-2 {
    font-weight: 600;
  }

  .toc-depth-3 {
    font-size: 0.9em;
    opacity: 0.9;
  }

  /* Active TOC item highlighting */
  .toc-link.active {
    background-color: rgba(var(--accent-rgb), 0.15);
    color: var(--color-accent);
    font-weight: 600;
    border-left: 3px solid var(--color-accent);
  }

  /* Progress indicator on TOC items */
  .toc-link.read {
    opacity: 0.6;
  }

  .toc-link.active.read {
    opacity: 1;
  }
</style>

<script>
  function initTableOfContents() {
    const headings = Array.from(
      document.querySelectorAll(
        "#article h2[id], #article h3[id], #article h4[id]"
      )
    );
    const tocLinks = Array.from(
      document.querySelectorAll(".toc-link")
    ) as HTMLElement[];

    if (headings.length === 0 || tocLinks.length === 0) return;

    // Track which headings have been read
    const readHeadings = new Set<string>();

    // Create intersection observer for active heading tracking
    const activeObserver = new IntersectionObserver(
      entries => {
        entries.forEach(entry => {
          const id = entry.target.getAttribute("id");
          if (!id) return;

          if (entry.isIntersecting) {
            // Mark as read
            readHeadings.add(id);

            // Update active state
            tocLinks.forEach(link => {
              const linkId = link.getAttribute("data-heading-id");
              link.classList.remove("active");

              if (linkId === id) {
                link.classList.add("active");
              }

              // Add read state
              if (readHeadings.has(linkId || "")) {
                link.classList.add("read");
              }
            });

            // Scroll TOC to show active item
            const activeLink = tocLinks.find(
              link => link.getAttribute("data-heading-id") === id
            );
            if (activeLink) {
              const tocAside = document.getElementById("toc-aside");
              if (tocAside) {
                const linkTop = activeLink.offsetTop;
                const asideHeight = tocAside.clientHeight;
                const linkHeight = activeLink.clientHeight;

                // Center the active link in the viewport
                tocAside.scrollTo({
                  top: linkTop - asideHeight / 2 + linkHeight / 2,
                  behavior: "smooth",
                });
              }
            }
          }
        });
      },
      {
        rootMargin: "-100px 0px -66%",
        threshold: 0.5,
      }
    );

    // Observe all headings
    headings.forEach(heading => activeObserver.observe(heading));

    // Smooth scroll for TOC links
    tocLinks.forEach(link => {
      link.addEventListener("click", e => {
        e.preventDefault();
        const targetId = link.getAttribute("data-heading-id");
        const target = document.getElementById(targetId || "");
        if (target) {
          const offset = 100;
          const targetPosition =
            target.getBoundingClientRect().top + window.pageYOffset - offset;
          window.scrollTo({
            top: targetPosition,
            behavior: "smooth",
          });
        }
      });
    });
  }

  // Initialize on page load
  initTableOfContents();

  // Re-initialize after Astro page transitions
  document.addEventListener("astro:after-swap", initTableOfContents);
</script>
