---
import { slugifyStr } from "@/utils/slugify";
import type { CollectionEntry } from "astro:content";
import Datetime from "./Datetime.astro";
import Tag from "./Tag.astro";

export interface Props {
  href?: string;
  frontmatter: CollectionEntry<"blog">["data"];
  secHeading?: boolean;
  coverImage?: string;
}

const { href, frontmatter, secHeading = true, coverImage } = Astro.props;
const { title, pubDatetime, modDatetime, description, tags, ogImage } = frontmatter;
const displayImage = coverImage || ogImage;
const imageSrc = typeof displayImage === "string" ? displayImage : displayImage?.src;

const headingProps = {
  style: { viewTransitionName: slugifyStr(title) },
  class:
    "font-display text-lg font-semibold leading-snug tracking-tight transition-colors duration-200 group-hover:text-accent",
};

const accentHue =
  title.split("").reduce((acc, char) => acc + char.charCodeAt(0), 0) % 360;
const cardAccent = `hsl(${accentHue} 72% 44%)`;
---

<li
  class="card group relative my-2 overflow-hidden p-3 sm:p-4"
  style={`--card-accent:${cardAccent};`}
>
  <div
    class="pointer-events-none absolute top-0 left-0 h-0.5 w-full opacity-70"
    style="background: linear-gradient(90deg, var(--card-accent), transparent 72%);"
  />

  <div class:list={[imageSrc ? "grid gap-3 sm:grid-cols-[132px,1fr] sm:items-center" : ""]}>
    {
      imageSrc && (
        <a
          href={href}
          class="card-cover group/image focus-outline block h-36 overflow-hidden rounded-xl border border-border/70 sm:h-32"
          aria-label={title}
        >
          <img
            src={imageSrc}
            alt={title}
            loading="lazy"
            class="h-full w-full object-cover transition-transform duration-300 group-hover/image:scale-105"
          />
        </a>
      )
    }

    <div class="min-w-0">
      <a
        href={href}
        class="focus-outline block rounded-md p-0.5 text-accent/90 no-underline transition-transform duration-200 group-hover:translate-x-0.5"
      >
        {
          secHeading ? (
            <h2 {...headingProps}>{title}</h2>
          ) : (
            <h3 {...headingProps}>{title}</h3>
          )
        }
      </a>

      <Datetime pubDatetime={pubDatetime} modDatetime={modDatetime} />

      <p class="mt-2 line-clamp-2 text-sm text-foreground/80 sm:text-base">
        {description}
      </p>

      {
        tags && (
          <ul class="mt-2 flex flex-wrap gap-1.5">
            {tags.map(tag => <Tag tag={slugifyStr(tag)} tagName={tag} />)}
          </ul>
        )
      }
    </div>
  </div>
</li>

<style>
  .card-cover {
    background: color-mix(in srgb, var(--color-surface-2) 72%, transparent);
    box-shadow: var(--shadow-sm);
  }
</style>
